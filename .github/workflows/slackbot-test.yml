name: Slackbot Test

on:
  workflow_dispatch:

jobs:
  test-connection:
    runs-on: ubuntu-latest
    steps:
      - name: Send Slack test message
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          SLACK_CHANNEL: C0A7QE8K7R8
        run: |
          set -eo pipefail
          # Sample payload mirrors citation-check format to validate Slack schema
          payload=$(python -c $'import json, os\n\n'"'"'def format_table(md):\n    lines = md.splitlines()\n    table = []\n    prefix = []\n    in_table = False\n    for ln in lines:\n        st = ln.strip()\n        if st.startswith("|") and st.endswith("|") and "|" in st[1:-1]:\n            parts = [p.strip() for p in st.strip("|").split("|")]\n            if all(set(p) <= set("-:")):\n                in_table = True\n                continue\n            in_table = True\n            table.append(parts)\n        else:\n            if not in_table:\n                prefix.append(ln)\n    if not table:\n        return md\n    widths = [max(len(r[i]) for r in table) for i in range(len(table[0]))]\n    table_lines = [" | ".join(r[i].ljust(widths[i]) for i in range(len(widths))) for r in table]\n    body = "\\n".join([ln for ln in prefix if ln.strip()])\n    if body:\n        body += "\\n"\n    body += "\\n".join(table_lines)\n    return body\n\n'"'"'\ntitle="Citation check finished for citation-check-test"\nsummary="Sample summary for Slack schema validation."\nformatted=format_table(summary)\nsummary_block=f"```\\n{formatted}\\n```"\npayload={"channel":os.environ["SLACK_CHANNEL"],"text":title,"blocks":[{"type":"section","text":{"type":"mrkdwn","text":f"*{title}*"}},{"type":"section","text":{"type":"mrkdwn","text":"Summary below."}},{"type":"section","text":{"type":"mrkdwn","text":summary_block}}]}\nprint(json.dumps(payload))')
          curl -X POST https://slack.com/api/chat.postMessage \
            -H "Authorization: Bearer $SLACK_BOT_TOKEN" \
            -H "Content-Type: application/json" \
            --data "$payload"
