name: Slackbot Test

on:
  workflow_dispatch:

jobs:
  test-connection:
    runs-on: ubuntu-latest
    steps:
      - name: Send Slack test message
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          SLACK_CHANNEL: C0A7QE8K7R8
        run: |
          set -eo pipefail
          # Sample payload mirrors citation-check format to validate Slack schema
          payload=$(python - <<'PY'
          import json
          import os
          import textwrap


          def compact(text: str, limit: int = 120) -> str:
            return text if len(text) <= limit else text[: limit - 1] + '…'


          title = 'Citation check finished for citation-check-test'

          rows = [
            {
              'prompt': 'Reddit marketing agency for AI startups marketing on Reddit UK agencies Reddit marketing specialised',
              'target': 'https://infrasity.com/services/reddit-marketing-agency',
              'status': 'cited URL(s): https://infrasity.com/services/reddit-marketing-agency',
              'other': [
                'https://theredditmarketingagency.com/lp-ahyanah',
                'https://upvoteagency.com',
                'https://discoveredlabs.com/services/reddit-marketing-agency',
              ],
            },
            {
              'prompt': 'Reddit marketing agency for AI startups marketing on Reddit US agencies Reddit marketing specialised',
              'target': 'https://infrasity.com/services/reddit-marketing-agency',
              'status': 'cited URL(s): https://infrasity.com/services/reddit-marketing-agency',
              'other': [
                'https://foundationinc.co/services/reddit-agency',
                'https://reddithero.com',
                'https://singlegrain.com/search-everywhere-optimization/10-best-reddit-agencies-in-2025-complete-guide-for-b2b-success',
              ],
            },
            {
              'prompt': 'Reddit marketing agency for AI startups marketing on Reddit Israel agencies Reddit marketing specialised',
              'target': '',
              'status': 'no target URLs cited',
              'other': [
                'https://getemall.com',
                'https://roshdigital.co.il',
                'https://moov.co.il',
              ],
            },
          ]

          lines = [
            '## 20260109T130911Z',
            '### Provider: openrouter | Model: gpt-oss-20b-free-online',
            '',
          ]

          for idx, row in enumerate(rows, start=1):
            lines.append(f"*Entry {idx}*")
            lines.append(f"• Prompt: {compact(row['prompt'])}")
            lines.append(f"• Target: {row['target'] or '—'}")
            lines.append(f"• Status: {row['status']}")
            if row['other']:
              lines.append("• Other URLs:")
              for url in row['other']:
                lines.append(f"    - {url}")
            lines.append('')

          summary_block = '\n'.join(lines).strip()

          payload = {
            'channel': os.environ['SLACK_CHANNEL'],
            'text': title,
            'blocks': [
              {'type': 'section', 'text': {'type': 'mrkdwn', 'text': f'*{title}*'}},
              {'type': 'section', 'text': {'type': 'mrkdwn', 'text': 'Summary below.'}},
              {'type': 'section', 'text': {'type': 'mrkdwn', 'text': summary_block}},
            ],
          }

          print(json.dumps(payload))
          PY
          )
          curl -X POST https://slack.com/api/chat.postMessage \
            -H "Authorization: Bearer $SLACK_BOT_TOKEN" \
            -H "Content-Type: application/json" \
            --data "$payload"
